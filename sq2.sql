
select *,'current' as data_state
,SUM(CASE 
    WHEN trx_approved_date_month BETWEEN FORMAT_DATE('%Y-%m', DATE_SUB(CURRENT_DATE(), INTERVAL 9 MONTH)) 
    AND FORMAT_DATE('%Y-%m', DATE_SUB(CURRENT_DATE(), INTERVAL 5 MONTH)) 
    THEN mob15_projection 
    ELSE 0 
  END) OVER (
    PARTITION BY business_segment,offline_area,offline_greater_area,offline_greater_area_2,offline_initial_area_simplified,mp_category_custom,offline_item_category,itemcategory,merchantname,storename,merchant_category,itemctgoff,itemctgoff_highlevel,tenure_adj_modif_nicho,offline_brand_name_modif_nicho,offline_greater_area_modif_nicho,offline_brand_group,loan_amount_bin,submit_cash_7d,submit_cash_approved_7d ,submit_cash_cancel_7d,offline_store_category_at_trx,submit_cash_30d_flag ,rejectnq_cash_flag ,rejectnq_cash_30d_flag,rejectnq_cash_90d_flag,pefindo_score_bin,pefindo_score_bin_2,pefindo_score10_bin,pefindo_score_bin_longer,offline_score_bin,offline_score20_bin,identity_score_bin,identity_score_bin_2
    --tiket_loyalty_status,merchant_region,merchant_region_capital,merchant_city_tier,merchant_postal_code_type,merchant_city_tier_ctg,merchant_city,offline_sub_item_category,offline_new_intrate,offline_mutation_ins,offline_mutation_ins_flag,offline_new_intrate_modif,offline_new_intrate_top5
    -- ,offline_item_category_2,offline_item_category_3,offline_initial_item_category_2,fee_scheme,user_promo_riskGrade,age_comply,income_comply,risk_grade,risk_grade_jul24,risk_grade_jul24_complete,rg10_jul24_complete,rg20_jul24_complete,rbp_promo_flag,coupon_code,current_whitelist_greylist,current_whitelist,current_greylist,pefindo_score_risk_grade,pefindo_offline_score_risk_grade, offline_mall_name,offline_item_name,offline_initial_store_category,pefindo_offline_score_risk_grade_combined,pefindo_offline_score_risk_grade_combined_abcde,pefindo_offline_score_risk_grade_combined_abcde_newrg
    --,user_segment_trx,,item_category_gladys,new_vgood_category,mall_category,era_ivan_ctg,submit_cash,submit_cash_approved,submit_cash_cancel,payment_flag,payment_flag_ctg_user,trx_category,payment_flag_ctg,itemname

    --,offline_conditional_0_promo_auto,offline_conditional_0_promo
    --,pefindo_offline_score_risk_grade_combined_a1a7bcde_newrg,risk_grade_nicho,pefindo_offline_score_risk_grade_combined_a13b15c13de_nicho_adj_feb26,risk_grade_nicho_flag, pefindo_offline_score_risk_grade_combined_abcde_origination,user_promo_riskGrade_rbp,offline_item_category_rbp,offline_merchant_risk_category_rbp,is_existing_user_rbp,offline_item_category_2_rbp,offline_merchant_risk_category_group_rbp
--    score_trx_log_bin,phone_model_ctg,user_flag,fdc_flag,is_coupon_used,toped_item_ctg,limit_exposure_at_trx_ctg,day_interval_from_submit_bin,acquisition_channel,trx_utilize_flag,max_dpd_before_trx_bin,limit_increase_ctg_oid_jun23,limit_exposure,store_category,latest_store_category,avanto_store_ctg,offline_brand_rank,offline_merchant_rank,offline_coupon_benefit_category,cash_active_ctg,current_silverlist,merchantname_high_level,provision_rate_offline_trx,interest_rate_offline_trx,intrate,offline_intrate
    --,offline_store_category,offline_initial_brand_name,offline_brand_name,offline_brand_modern_tradi_tag,offline_area_simplified,offline_city_tier_ctg,top_1000_merchant,top_2000_merchant, userPromoRiskGrade_sep_25,merchant_group_sep_25,userPromoRiskGrade_jan_26,merchant_group_jan_26,cash_active_ctg_usr,maxout1d85,mod100k,mod500k,mod1mio,silver_list_ctg,prev_cash_ctg_last_30d,last_limit_status_final_main_limit,main_business_segment_q,medan_fraud_flag,submit_cash_1d_after_flag,submit_cash_3d_after_flag,submit_cash_7d_after_flag,is_tokopedia,merchant_name_group,merchant_name_group_2,offline_RO_45d,offline_RO,offline_RO_2,limit_increase_christie,limit_increase_christie_tiket_only,offline_agent_name,offline_spl_name
    ) AS mob15_projection_static

,SUM(CASE 
    WHEN trx_approved_date_month BETWEEN FORMAT_DATE('%Y-%m', DATE_SUB(CURRENT_DATE(), INTERVAL 9 MONTH)) 
    AND FORMAT_DATE('%Y-%m', DATE_SUB(CURRENT_DATE(), INTERVAL 5 MONTH)) 
    THEN mob15_projection_princ_matured 
    ELSE 0 
  END) OVER (
     PARTITION BY business_segment,offline_area,offline_greater_area,offline_greater_area_2,offline_initial_area_simplified,mp_category_custom,offline_item_category,itemcategory,merchantname,storename,merchant_category,itemctgoff,itemctgoff_highlevel,tenure_adj_modif_nicho,offline_brand_name_modif_nicho,offline_greater_area_modif_nicho,offline_brand_group,loan_amount_bin,submit_cash_7d,submit_cash_approved_7d ,submit_cash_cancel_7d,offline_store_category_at_trx,submit_cash_30d_flag ,rejectnq_cash_flag ,rejectnq_cash_30d_flag,rejectnq_cash_90d_flag,pefindo_score_bin,pefindo_score_bin_2,pefindo_score10_bin,pefindo_score_bin_longer,offline_score_bin,offline_score20_bin,identity_score_bin,identity_score_bin_2
    --tiket_loyalty_status,merchant_region,merchant_region_capital,merchant_city_tier,merchant_postal_code_type,merchant_city_tier_ctg,merchant_city,offline_sub_item_category,offline_new_intrate,offline_mutation_ins,offline_mutation_ins_flag,offline_new_intrate_modif,offline_new_intrate_top5
    -- ,offline_item_category_2,offline_item_category_3,offline_initial_item_category_2,fee_scheme,user_promo_riskGrade,age_comply,income_comply,risk_grade,risk_grade_jul24,risk_grade_jul24_complete,rg10_jul24_complete,rg20_jul24_complete,rbp_promo_flag,coupon_code,current_whitelist_greylist,current_whitelist,current_greylist,pefindo_score_risk_grade,pefindo_offline_score_risk_grade, offline_mall_name,offline_item_name,offline_initial_store_category,pefindo_offline_score_risk_grade_combined,pefindo_offline_score_risk_grade_combined_abcde,pefindo_offline_score_risk_grade_combined_abcde_newrg
    --,user_segment_trx,,item_category_gladys,new_vgood_category,mall_category,era_ivan_ctg,submit_cash,submit_cash_approved,submit_cash_cancel,payment_flag,payment_flag_ctg_user,trx_category,payment_flag_ctg,itemname

    --,offline_conditional_0_promo_auto,offline_conditional_0_promo
    --,pefindo_offline_score_risk_grade_combined_a1a7bcde_newrg,risk_grade_nicho,pefindo_offline_score_risk_grade_combined_a13b15c13de_nicho_adj_feb26,risk_grade_nicho_flag, pefindo_offline_score_risk_grade_combined_abcde_origination,user_promo_riskGrade_rbp,offline_item_category_rbp,offline_merchant_risk_category_rbp,is_existing_user_rbp,offline_item_category_2_rbp,offline_merchant_risk_category_group_rbp
--    score_trx_log_bin,phone_model_ctg,user_flag,fdc_flag,is_coupon_used,toped_item_ctg,limit_exposure_at_trx_ctg,day_interval_from_submit_bin,acquisition_channel,trx_utilize_flag,max_dpd_before_trx_bin,limit_increase_ctg_oid_jun23,limit_exposure,store_category,latest_store_category,avanto_store_ctg,offline_brand_rank,offline_merchant_rank,offline_coupon_benefit_category,cash_active_ctg,current_silverlist,merchantname_high_level,provision_rate_offline_trx,interest_rate_offline_trx,intrate,offline_intrate
    --,offline_store_category,offline_initial_brand_name,offline_brand_name,offline_brand_modern_tradi_tag,offline_area_simplified,offline_city_tier_ctg,top_1000_merchant,top_2000_merchant, userPromoRiskGrade_sep_25,merchant_group_sep_25,userPromoRiskGrade_jan_26,merchant_group_jan_26,cash_active_ctg_usr,maxout1d85,mod100k,mod500k,mod1mio,silver_list_ctg,prev_cash_ctg_last_30d,last_limit_status_final_main_limit,main_business_segment_q,medan_fraud_flag,submit_cash_1d_after_flag,submit_cash_3d_after_flag,submit_cash_7d_after_flag,is_tokopedia,merchant_name_group,merchant_name_group_2,offline_RO_45d,offline_RO,offline_RO_2,limit_increase_christie,limit_increase_christie_tiket_only,offline_agent_name,offline_spl_name
    )  AS mob15_projection_princ_static
,SAFE_DIVIDE(
  SUM(CASE 
    WHEN trx_approved_date_month BETWEEN FORMAT_DATE('%Y-%m', DATE_SUB(CURRENT_DATE(), INTERVAL 9 MONTH)) 
    AND FORMAT_DATE('%Y-%m', DATE_SUB(CURRENT_DATE(), INTERVAL 5 MONTH)) 
    THEN mob15_projection 
    ELSE 0 
  END) OVER (
    PARTITION BY offline_item_category_3, pefindo_offline_score_risk_grade_combined_abcde_newrg, 
                 offline_brand_name_modif_nicho, offline_brand_group, offline_greater_area_modif_nicho
  ),
  SUM(CASE 
    WHEN trx_approved_date_month BETWEEN FORMAT_DATE('%Y-%m', DATE_SUB(CURRENT_DATE(), INTERVAL 9 MONTH)) 
    AND FORMAT_DATE('%Y-%m', DATE_SUB(CURRENT_DATE(), INTERVAL 5 MONTH)) 
    THEN mob15_projection_princ_matured 
    ELSE 0 
  END) OVER (
    PARTITION BY business_segment,tiket_loyalty_status,merchant_region,merchant_region_capital,merchant_city_tier,merchant_postal_code_type,merchant_city_tier_ctg,merchant_city,offline_sub_item_category,offline_new_intrate,offline_mutation_ins,offline_mutation_ins_flag,offline_new_intrate_modif,offline_new_intrate_top5,offline_conditional_0_promo_auto,offline_conditional_0_promo,mp_category_custom,offline_item_category,offline_item_category_2,offline_item_category_3,offline_initial_item_category_2,fee_scheme,user_promo_riskGrade,age_comply,income_comply,risk_grade,risk_grade_jul24,risk_grade_jul24_complete,rg10_jul24_complete,rg20_jul24_complete,rbp_promo_flag,coupon_code,current_whitelist_greylist,current_whitelist,current_greylist,pefindo_score_risk_grade,pefindo_offline_score_risk_grade,pefindo_offline_score_risk_grade_combined,pefindo_offline_score_risk_grade_combined_abcde,pefindo_offline_score_risk_grade_combined_abcde_newrg,pefindo_offline_score_risk_grade_combined_abcde_newrg_adj_sep25,pefindo_offline_score_risk_grade_combined_a1a7bcde_newrg,risk_grade_nicho,pefindo_offline_score_risk_grade_combined_a13b15c13de_nicho_adj_feb26,risk_grade_nicho_flag --,pefindo_offline_score_risk_grade_combined_abcde_origination,user_promo_riskGrade_rbp,offline_item_category_rbp,offline_merchant_risk_category_rbp,is_existing_user_rbp,offline_item_category_2_rbp,offline_merchant_risk_category_group_rbp,loan_amount_bin,user_segment_trx,submit_cash_7d,submit_cash_approved_7d ,submit_cash_cancel_7d,offline_store_category_at_trx,submit_cash_30d_flag ,rejectnq_cash_flag ,rejectnq_cash_30d_flag,rejectnq_cash_90d_flag,pefindo_score_bin,pefindo_score_bin_2,pefindo_score10_bin,pefindo_score_bin_longer,offline_score_bin,offline_score20_bin,identity_score_bin,identity_score_bin_2,item_category_gladys,new_vgood_category,mall_category,era_ivan_ctg,submit_cash,submit_cash_approved,submit_cash_cancel,payment_flag,payment_flag_ctg_user,trx_category,payment_flag_ctg,itemname,itemcategory,merchantname,storename,merchant_category,score_trx_log_bin,phone_model_ctg,user_flag,fdc_flag,is_coupon_used,toped_item_ctg,limit_exposure_at_trx_ctg,day_interval_from_submit_bin,acquisition_channel,trx_utilize_flag,max_dpd_before_trx_bin,limit_increase_ctg_oid_jun23,limit_exposure,store_category,latest_store_category,avanto_store_ctg,offline_brand_rank,offline_merchant_rank,itemctgoff,itemctgoff_highlevel,offline_coupon_benefit_category,cash_active_ctg,offline_area,current_silverlist,merchantname_high_level,provision_rate_offline_trx,interest_rate_offline_trx,intrate,flag_dpd_15_installment_1,flag_dpd_15_installment_3,offline_intrate,offline_mall_name,offline_item_name,offline_initial_store_category,offline_store_category,offline_initial_brand_name,offline_brand_name,offline_brand_modern_tradi_tag,offline_greater_area,offline_greater_area_2,offline_initial_area_simplified,offline_area_simplified,offline_city_tier_ctg,top_1000_merchant,top_2000_merchant, userPromoRiskGrade_sep_25,merchant_group_sep_25,userPromoRiskGrade_jan_26,merchant_group_jan_26,cash_active_ctg_usr,maxout1d85,mod100k,mod500k,mod1mio,silver_list_ctg,prev_cash_ctg_last_30d,last_limit_status_final_main_limit,main_business_segment_q,medan_fraud_flag,submit_cash_1d_after_flag,submit_cash_3d_after_flag,submit_cash_7d_after_flag,is_tokopedia,merchant_name_group,merchant_name_group_2,flag_dpd_3_123456,flag_dpd_3_123,flag_dpd_3,flag_dpd_1,offline_RO_45d,offline_RO,offline_RO_2,limit_increase_christie,limit_increase_christie_tiket_only,offline_agent_name,offline_spl_name,offline_initial_risk_grade,is_mandatory_dp_brand,mom_report_flag_exclude,is_ins_mature,is_paid_all_loan,is_current_last_1m_submit,is_current_last_6m_submit,is_current_last_12m_submit,is_current_last_18m_submit,score_qcut_10,score_qcut_20,blibli_score_qcut_10,blibli_score_qcut_20,submit_above_2023,submit_above_2024,submit_above_2025,new_user_flag,risk_final_ctg,phone_operator,is_mtd_data,tenure_adj_modif_nicho,offline_brand_name_modif_nicho,offline_greater_area_modif_nicho,offline_brand_group,merchant_city_tier_ctg_adj
  )
) AS proj_mob15_PERC_STATIC
  ,DATE_DIFF(CURRENT_DATE(), CAST(CONCAT(trx_approved_date_month, '-01') AS DATE), MONTH) AS month_diff_from_current

,COALESCE(projected_mob15_based_on_mob9,projected_mob15_based_on_mob6,projected_mob15_based_on_mob4,projected_mob15_based_on_mob3,projected_mob15_based_on_mob2,projected_mob15_based_on_mob1) AS mob15_projection_v2
from `athena-179008.vayu_data_mart.trx_raw_gsheet_monitoring_pivot_dupe_group`